{% extends "base.html" %}
{% load static %}
{% block title %} Inicio {% endblock %}
{% block content %}
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    ...
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Save changes</button>
                </div>
            </div>
        </div>
    </div>

    <h1>QR Code Scanner</h1>
    <video id="video" width="300" height="200" autoplay></video>
    <canvas id="canvas" hidden></canvas>
    <p id="output">Scanning...</p>
    <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        const output = document.getElementById('output');

        navigator.mediaDevices.getUserMedia({video: {facingMode: 'environment'}})
            .then(stream => {
                video.srcObject = stream;
                video.addEventListener('loadedmetadata', () => {
                    video.play();
                    scanQRCode();
                });
            })
            .catch(err => {
                output.textContent = `Error accessing camera: ${err}`;
            });

        function scanQRCode() {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, canvas.width, canvas.height);

                if (code) {
                    try {
                        const qrData = code.data;
                        if (qrData) {
                            const zone_id = qrData.split("/").pop();

                        output.textContent = `QR code ${zone_id}`;
                            const url = "{% url 'try_capture' key='PLACEHOLDER' %}".replace('PLACEHOLDER', zone_id);
                            window.location.href=url;
                            return;
                        }
                    } catch (error) {
                        output.textContent = "Invalid QR code format";
                    }
                }
            }
            requestAnimationFrame(scanQRCode);
        }
    </script>

{% endblock %}